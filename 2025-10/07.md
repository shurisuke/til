# 2025-10-07：基礎ステップ総復習のメモ

今日はカリキュラムの基礎ステップ総復習問題を解いた。
課題で取り組む目安の時間は一時間だったが、なかなか時間がかかってしまった。
内容もとても難しく、知識が身についていくのを肌で感じた。


# マイグレーションに関するメソッド

マイグレーション（migration）は、
「データベースの設計変更を記録して、自動で反映する仕組み」

rails generate migration AddAgeToUsers age:integer

db/migrate/ フォルダにマイグレーションファイルが作られ、
rails db:migrate で実際のDBに反映される

# 新しいカラムを追加するマイグレーション
## コマンド: rails generate migration AddAgeToUsers age:integer
class AddAgeToUsers < ActiveRecord::Migration[7.0]
  def change
    add_column :users, :age, :integer
  end
end

# カラム名を変更するマイグレーション
## コマンド: rails generate migration RenameTitleToNameInBooks
class RenameTitleToNameInBooks < ActiveRecord::Migration[7.0]
  def change
    rename_column :books, :title, :name
  end
end

# 3. カラムを削除するマイグレーション
## コマンド: rails generate migration RemoveAgeFromUsers age:integer
class RemoveAgeFromUsers < ActiveRecord::Migration[7.0]
  def change
    remove_column :users, :age, :integer
  end
end

# migrationに関するメソッドのまとめ

コマンド             何をする？                                          どんなとき使う？

db:migrate          まだ実行していないマイグレーションだけを実行              通常の開発時（新しいmigrationを追加したとき）
db:reset            データベースを削除→再作成→schema.rbを読み込む           DBをまっさらな状態に戻したいとき
db:migrate:reset    DB削除→再作成→すべてのmigrationファイルを最初から実行    migrationの履歴ごと再構築したいとき


# destroyとdestroy!メソッドの違い

メソッド    削除失敗時の動作          返り値                       例外発生    用途
destroy    失敗しても例外を出さない   モデルオブジェクト自体          出ない     通常の削除処理（コントローラなど）
destroy!   失敗時に例外を発生させる   削除成功時はオブジェクトを返す   出る       トランザクションなどで確実に削除したい場合

## destroy: 失敗しても例外を出さない
user = User.find_by(email: "example@example.com")
if user.destroy
  puts "削除成功！"
else
  puts "削除失敗..."
end

## destroy!: 失敗時に例外を発生させる
user = User.find_by(email: "example@example.com")
user.destroy!   # 削除できなければ ActiveRecord::RecordNotDestroyed を発生

## destroy_all と destroy_all! の違い（複数レコード削除）
User.where(role: "guest").destroy_all      # 失敗しても止まらない
User.where(role: "guest").destroy_all!     # 失敗時に例外発生

## トランザクション内で destroy! を使う例
ActiveRecord::Base.transaction do
  old_posts.destroy_all!
  user.destroy!   # ここで失敗すれば、上の処理もロールバックされる
end
